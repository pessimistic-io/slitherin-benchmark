// SPDX-License-Identifier: MIT
/*
                                                                                                         .....(((.....
                                                                                                   ..<<<:::::::::::::::<?>(..
                                                                                               ..?<:::::::::::::::::::::::::<?i.
                                                                                             .zwA(:::::::::~::~:::::::::::::::::?1,
                                                                                           .wuuzuzx:::::~:::::::~::~::~::::::::::::?-
                                                          .(<~~~~?<-.                    .zuzuzzuzuX+::::::::~::::::::::~::~:::::::::?-
                                                        .<_~~.~~.~~~~(1.      ......    ,<zuzuzuzuzzzzo+::~::::::~:::~::::::::~::::::::1,
                                                       .>.~.~~..~..~.~~~?- .?>::::::<1-?::zzuzuzuzuuuzzzX&+::::::::::::::~::::::~:::::::?l
                                                       /.~(gNm~~.~~.~.~.~~j<:::::::::::<::(OuzzuzzzzuzzuzzuzO+(::~::~::::::~::::::~::::::(I                 
                                                      .~._MMM@~.~~(MN,.~..(>::::::::::::::::?OzuzuzuZOuzuzzzzzzzO++::::~::~::~:~:::~:~::::(l
                                                      (~~~~?<~..~.dMMF~.~.(<::~:~::~::~::::::::<<<:::zzuzuzuuzzzzzzzzw&++(::::::::::::~::::?l                  
                                                      <..~J$~.~~.~_7=_.~~~(::::::~:::::~:~:::::::::::juzzuzzuzuuuzuzzzzuzuzzww&&++++(J+++zwzX.
                                                      ._~.~4J_~.~~(e~.~.~~(::~::::::~:::::~:::::::::::juuzzuzzzuzuzuuzuzzuzzzzzzzzzzzzzzzzzuu[
                                                       <_~.~~?T"""!~~.~...(::::~::~:::~:::::~:~:~:~::::(?OzuuuzzzzZ>zuzzuzuzuzuzuzuzzuzuuzuzu0 
                                                        ?-~..~.~.~.~.~.~.._I:::::~:::::::~:::::::::~::::::::<<<<::::?uzuzzzuzuzuZOzuzzuzzuzuZz              
                                                          _<-_~~.~~.~-(J1((Jx::::::::(+++++-::::~:::~:~::::::::::::::(CXuzuzuzZC:(CuuzzuzuXC<;
                                                               <<<?<~-  ._~.(7+:::+<~..~.~~._?1+:::::::~::~::::::::::::::<<<::::::::<?77<<::(<<.     ..<<<.
                                                            ,<~..._<-(__!    __?+<.~.~~.~..~.~.~?+::~::::::~:~::~::~::::::::::::::::::::::::::::?, .<~....>
                                                            ./!  .   ~     .._<!(_~~~..~.~~.~.~.~_I:::::~:::::~:::~::~::~:::~::~:~:::::::::::~:::(<...~..(:
                                                        ...v<171_.    -(<,  ._!  ?-~.~~~.~~~.~~.~.(<???1:::::::::::::::~:::~::::::~:~:~::~::~:::::I..~._(!
                                                    .(<<;;;>>j-_:.-/?!   .i(-_(<<<(<<-_.~...~..~~(/  .~_<<+:+(:::~::~:::::~:::~:::::::::~:::::~:::v.~_(!
                                                .(<;:::::;;;;>?1zCi-.   _  ~_<_~ ..!<-_(+<<(((<<i.    -(<  .~_~~+_:::~::~:::::::~:++++(::::::::~:({-/ 
                                            ..?<::::::::::;;;;;;;>;+z.     .---.      .<...   ._   !-(<-_<<<<+. !(+<::::::::::(<<_~.~~.??1+:~:::+<!
                                          .?<::::::::::::::::;:;;;;;;?-   (!_((++--  (<-<.~(i_~       __~_  (> ?.. ...~?<<_?1+~.~.~~.~~~.~_?+:(v...
                                       .J>:::::::::::::::::::::::::::::?1<<<;;;>1zzI--?<(<v<_              (<   .1-     -< .!1-.~~.~..~.~..~_C<<<___~.
                                     .<::::::::::::::::::::::::::::::::::::::;;;;;;;;;;?1-+_          ...      _.->  ..~?<1...?j_.~.~~.~~~.~~_1:.  ~. 1
                                   .<:::::::::::::::::::::::::::::::;::::::::::::;;;;;;;;;+C..  ...-+--(v_    .<+-<!   ..;<.(l.~_<-~.~.~..~.~._} ..~?-- 
                                 .(:::::::::::::::::::::::::::::::::::::::::::::::::;;:;;;;;;?<<<<;>>>>?1+. .../_ : .!     <<:.<<!~_!(--_~~_-(<(!(_!!--?
                                ,<:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;:;;;;;;;;;><--> .-v<(.-1<<<1_( .      ___._!<! __   .\
                              .<::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;?1+~-   <(1+v._~(+1<1.!   .(_~_~~(_-      (
                             ,<:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;i.  ,>;;;;?11<;;j((?<<;?<...(...-!-.-(< 
                           .J:::::::~:::::::::::::::::::::::::::::::::::::::::::::::::::::~:::::::::::::::::::<::::;:;:::::;;;:;:::::::::;;<<<>>;>>+..   
                          .>::::~::::::~::~::::::::::::::::::::::::::::::::::::::::~::::~::::~:::~:::~:::~::::::::::::::::::::::::::::::::::;;;;;;;<<;;<-.    
                         .>::~:::::~:::::::::::~::::::::::::::::::::::::::::::::::::::~:::::::::::::~::~:::~~:~::~::~::::::::~::::::::::::::::::;;::<;;;;;;?+.
                        .<::::~::~::::~:::::~::::::::::::::::::::::::::::::::::::::::::::::~::~:::~:::::~::::~:~::~::~:~:~~:~:::::::~::~::::::::::::;:;;;;;;>}
                       .<::~::~:::::~:::::::::::::~::::::::::::::::::::::::::::~:~::::::::::::::~::::~:::~:~::::~::~::~::::~::::~:~::~::~:~~:~::::::;;;;;;;>>{
                      .<::~:~::~::~::::::~:::~::::::~::~::~::~::~::~::~:::::::::::::~::~::~::::::~::~::~::~:~:~::~::~::~:~::::~::~::~::~::::~::::::;;;;;;>>;>:
                     .>::::::~:::~::~::::::::::~:::::::::::::::::::::::::::~:::::::::::::::::~::~::~::~::~:::~::~::~::~::~:::~::::~::~::~::~::~:::::;;;;;>>>+~
                     <::~:~::~::~::::~:~::~::::::~:::~:::::::::::::::::::::::~::~::~:::::~::~::~:::::~::~::~:::~::~::~::~:::~::~:~::~::~:~::~:::::::;;;;>;>>+
                   .J::::~:~::~::~:~:::~::~::~:::::~::::~:~::~::~::~::~:::~::::::::::~:::::::::::~:~::~::~::~:~::~::~:::::::::~:::~::~::::~::~:::::;;;;>;>>>>
               ..(<(<::~::::~::~::~:~:::~:::~::~::::::~::::~:::::~:::::~:::~::::~:::::~:~::~:~:~::~::~::~::~:::~::~::~::~::~:~::~::~::~:~::~:::::::;;;;;>>>1!
           ..(:::::>::::~:~::~::~::::~::~::~::::~~::::::::::::~:::::~::::::::~:::~:~:::::~::~:~:~::~::~:::~::~::~::::::~::~::::~:::::::::~::~::::::;;;;;;>?<
       ..<<:::~:::(<~:~::~::~::~::~::~:~::~::~::::~:~~:~:~::~:::~::::::~::~:::~:~:::~::~::~::::::~::~::~:~::~:::~:(vI+:::::(+gHYWaJ_~(jMb::~::~:::::;;;;;>1:
   ..?<::::~:::~:~:::~::~::~::~::~:~::~::~::~:~:::::::::::~::~:::~:~:~::~::~:::::::~:~::~::~:~:~::~::~::~::~::~::(3;;?r:~(dHHHHHa ?MmHHM3::~::::::::::;;;?c
.<<:::::~:~:~:~:::~:::~::~::~::~::::~:::~::~:::~~:~::~::~::::::::::::::::::::(J.::~:::~::~::~::~:::~::~:::~::~:::Z;;;j3:(HHHHHHHHh. WM6:::::~:::::::::;;1j 
1:::::~::~:::~::~::~:~::~::~::::~:~::~:~::~::~:::~:~:~:~:~:~:~:~::~::~:~:~::Z<;;?G-::~::~::~::~::~::~::~::~::::::I;;+v:(dHHHHHHHHHb  Wb:(+Qs::~::::::;;;j'
 <:~:~:~::~:::~::~::~::~::~:::~:::::::::~:::~::~::::::~:::::(Jgmmme/?<(_::~:S;;;;;O+::~::~:::~::~:~::~::~::::~::~6;jC::+HHHHHHHHHHH; .MHHHM5:::::::::;;>j.
  1:::::~::~:~::~::~::~::~::~:::::~::~:::::~::::(JJJ(:::~(+MHHHHHHHHN+  _<::(4+;;;;u:::~::~:~::~:::~:::::::~::~::?C<::(WHHHHHHHHHHHb  (MY>::~:~:~::::;>>+_
   ?(::::~::::~::~::~:::::~::~:~~:::~::~::~:::~:?MHHHMHJ(MHHHHHHHHHHHHN,  _<::(C&+;j>:~::~:::~::~:::::~::~::~::~::::~:(HHHHHHHHHHHHM.  M<:~::~:::~:::;>>+{
    .1:::::::::::::::::~::::::::::~:::::::::::::::?7TWMMHHHHHHHHHHHHHHHMx   1::::(?7:::~::~:::::::~::~:::~:::~::~::~::JHHHHHHHHHHHHH{  dr::~:::~:::::;>>1:
      _+;;;;;:::::::~:::~::~::~:::::::::~::~::~:::::::+HHHHHHHHHHHHHHHHHM,   <:~::::~:::~:::~::~::::::~:~::~::~::~::~:JHH#HHHHHHHH#H)  ,b::~::~:~::::;>>+_
        ?1>>>>>;;;:::~::~:~:~::~::~::~:::::::+gmmag&JJWHHHHHHHHHHHHHHHHHHN    <:~:~:::~::::::~::~:~~:~:::~::~::~::~:::dHHHHHHHHHHHHH\  .@:::~::::~:::;;>+!
          ~1?>??>>;;::::::::::::~::~::~::~:::?MMHHHHHHHHHHHHHHHHHHHHHHHHH#;   .<:::::~:::~::~::::~::::~::~::~:::~::~::dHHHHHHHHHHHHH!   #           _~<;j~
            -<??>>+<:::~:::~::~::::::~::~:~::::::::::dHHHHHHHHHHHHHHHHHHHH]    <:::~::~:~:~::~:~:::~::~:~::~::~::~::~:JHHHHH#H#H#HH#    @               ( 
               ?1+j>::::~::::~:::~:::::::::~:~:::::::WHHHHHHHHHHHHHHHHHHH#F    .<:~::~:::::~::~:~:~:~::~::~::~:~::~:::JHHHHHHHHHHHHF    b               ,
                  ,I::~::~:~::~:::~:~::~::::::~:~~:::MHHHHHHHHHHHHHHHHHHHHF     >:::~::~:~::~::::~:::~:::~::~::::::~~ .HHHHHHHHHHHM!   .F              .~
                  .I::~::~::~::~:~::~:::~:~::::::::~:MHHHHHHHHHHHHHHHHHHH#\     I::~::~::~::~::~:::~::~::~::::~:~~     MHHHHHHHHHHF    .%             ..{
                   I:::~:::~::~::~:::~:~:::~:~:::::::WHHHHH#H#HHHH#H#H#HHM      >~~:::::~::::~::~:::~:::~::::~         (MHHHHHHH#F     ,             ..( 
                   (::::::::::::::~:::~::~::~~~~     JHHHHHHHHHHHHHHHHHHHF      :        ~~~::::((xXNMBY4m/             (MHHHHH#F      r             ..(
                   .>:::~::~::~:::::~~~              ,HHHHHHHHHHHHHHHHHH@       ~              (#<~:(<~~:J]             ~.UH#M#^      .!            ..-{
                    1::~:::::::~~                     MVHHHHHHHHHHHHHH##       .               (b~:~~:~:(V               _           .%             ..( 
                    .<::::~~                          Jb?MHHHHHHHHHH#H@        :                (4QJ-(JY!                ..         .%      .__.   ..-;
                     1:~~                              M,,H#HHHHHH#HM=        ,                     d#                    ..       .^      _:::~  ...(
                     .-                                ,N. (YMMHHMY^         .                      d#                      ~.  ..=       _:~::~  ..-:
                      (.                                /h.                 .                       dN.              .r                  .:::~~  .../
                       i                                 ,N,               ,                      .M@@MN,.        .."!                   :~:::   ..( 
                        >                                  Ta.           .!      .             ..M@@@@@@@MMHggz7"=                      .:~:~  ...(!
                        .-                                   ?4&..   .._         ?"Ha.......JHM@@HHHHWWWHHHH@P                           ::~  ...-:
                         .-               .::::::-.                                        W@HHWyyyyyyyyZyyyW\                               ..._~
                          .:             .::~::::::_                                       dHyyZyZZyZZyZyyZyy!                               .._~
                            1             :::~:~:~:::.                                     dyyZyyyZyyZyyZyZy$                              ...-!
                             ?.           _:~:::~::::_                                     jyZyZyZyyZyyZyZyX!                             ...( 
                              .-            ~:::::~::~                                     .yyZyZyyZyZyyZyX'                             ..-/
                                <.            ~~:::~~                                       jyyyyZyyZyZyyf!                            .._(!
                                 .-                                                          ?UyyZyyyyXY!                            ...(!
                                   ~.                                                           ?777?                               .--!
                                     !.                                                                                           .-(!
                                       _-                                                                                       .-? 
                                          ~.                                                                                 .-? 
                                             ~.                                                                          ..? 
                                                !-.                                                                 ..~!
                                                    !-.                                                      ...~?!
                                                        _?~(...                                      ....(J? 
*/

pragma solidity ^0.8.9;

import "./Ownable.sol";
import "./ERC721Enumerable.sol";
import "./Strings.sol";
import "./console.sol";
import "./ERC2981.sol";
import "./ERC721Pausable.sol";
import "./ERC721A.sol";

// contract ChiitanNFT is ERC721Enumerable, ERC2981, Ownable, Pausable {
contract ChiitanNFT is ERC721A, ERC2981, Ownable, Pausable {
    using Strings for uint256;

    string baseURI = '';
    string public baseExtension = '.json';

    uint256 public freeMintCost = 0 ether;
    uint256 public preCost;
    uint256 public publicCost;

    // Upgradable
    uint256 public maxSupply;

    uint256 public publicMaxPerTx;

    bool public revealed = false;
    bool public freemint = false;
    bool public presale = false;
    bool public publicsale = false;

    string public notRevealedUri;
    uint256 private whiteListCount = 0;
    uint256 private freeMintListCount = 0;
    mapping(address => uint256) private whiteLists;
    mapping(address => uint256) private freeMintLists;

    address public royaltyAddress;
    uint96 public royaltyFee;

    constructor(
        string memory _name,
        string memory _symbol,
        uint256 _maxSupply,
        uint256 _publicMaxPerTx,
        uint256 _preCost,
        uint256 _publicCost,
        address _royaltyAddress,
        uint96 _royaltyFee,
        string memory _initNotRevealedUri
    ) ERC721A(_name, _symbol) {
        setMaxSupply(_maxSupply);
        setPublicMaxPerTx(_publicMaxPerTx);
        setPreCost(_preCost);
        setPublicCost(_publicCost);
        royaltyFee = _royaltyFee;
        royaltyAddress = _royaltyAddress;
        _setDefaultRoyalty(royaltyAddress, royaltyFee);
        setNotRevealedURI(_initNotRevealedUri);
    }

    // internal
    function _baseURI() internal view virtual override returns (string memory) {
        return baseURI;
    }

    // public mint
    function publicMint(uint256 _mintAmount) public payable whenNotPaused {
        uint256 supply = totalSupply();
        uint256 cost = publicCost * _mintAmount;
        mintCheck(_mintAmount, supply, cost);
        require(tx.origin == msg.sender, 'NOT_EOA');
        require(publicsale, 'Public mint is not active.');
        require(_mintAmount <= publicMaxPerTx, 'Mint amount over');

        _safeMint(msg.sender, _mintAmount);
    }

    // private mint
    function preMint(uint256 _mintAmount) public payable whenNotPaused {
        uint256 supply = totalSupply();
        uint256 cost = preCost * _mintAmount;
        mintCheck(_mintAmount, supply, cost);
        require(presale, 'Presale is not active.');
        require(
            whiteLists[msg.sender] >= _mintAmount,
            "You don't have WhiteList"
        );

        _safeMint(msg.sender, _mintAmount);
        whiteLists[msg.sender] = whiteLists[msg.sender] - _mintAmount;
    }

    // free mint
    function freeMint(uint256 _mintAmount) public payable whenNotPaused {
        uint256 supply = totalSupply();
        uint256 cost = 0;
        mintCheck(_mintAmount, supply, cost);
        require(freemint, 'Free mint is not active.');

        require(
            freeMintLists[msg.sender] >= _mintAmount,
            "You don't have FreeMintList"
        );

        _safeMint(msg.sender, _mintAmount);
        freeMintLists[msg.sender] = freeMintLists[msg.sender] - _mintAmount;
    }

    function mintCheck(
        uint256 _mintAmount,
        uint256 supply,
        uint256 cost
    ) private view {
        require(_mintAmount > 0, 'Mint amount cannot be zero');
        require(
            supply + _mintAmount <= maxSupply,
            'Total supply cannot exceed maxSupply'
        );
        require(msg.value >= cost, 'Not enough funds provided for mint');
    }

    function ownerMint(address walletAddress, uint256 _mintAmount)
        public
        onlyOwner
    {
        uint256 supply = totalSupply();
        require(
            supply + _mintAmount <= maxSupply,
            'Total supply cannot exceed maxSupply'
        );

        _safeMint(walletAddress, _mintAmount);
    }

    function tokenURI(uint256 tokenId)
        public
        view
        virtual
        override
        returns (string memory)
    {
        require(
            _exists(tokenId),
            'ERC721Metadata: URI query for nonexistent token'
        );

        if (revealed == false) {
            return notRevealedUri;
        }

        string memory currentBaseURI = _baseURI();
        return
            bytes(currentBaseURI).length > 0
                ? string(
                    abi.encodePacked(
                        currentBaseURI,
                        tokenId.toString(),
                        baseExtension
                    )
                )
                : '';
    }

    function reveal() public onlyOwner {
        revealed = true;
    }

    function is_revealed() public view returns (bool) {
        return revealed;
    }

    function setMaxSupply(uint256 _maxSupply) public onlyOwner {
        maxSupply = _maxSupply;
    }

    function setPublicMaxPerTx(uint256 _publicMaxPerTx) public onlyOwner {
        publicMaxPerTx = _publicMaxPerTx;
    }

    function setPreCost(uint256 _preCost) public onlyOwner {
        preCost = _preCost;
    }

    function setPublicCost(uint256 _publicCost) public onlyOwner {
        publicCost = _publicCost;
    }

    function activateFreemint() public onlyOwner {
        freemint = true;
        presale = false;
        publicsale = false;
    }

    function activatePresale() public onlyOwner {
        freemint = false;
        presale = true;
        publicsale = false;
    }

    function activatePublicsale() public onlyOwner {
        freemint = false;
        presale = false;
        publicsale = true;
    }

    function saleEnd() public onlyOwner {
        freemint = false;
        presale = false;
        publicsale = false;
    }

    function setNotRevealedURI(string memory _notRevealedURI) public onlyOwner {
        notRevealedUri = _notRevealedURI;
    }

    function setBaseURI(string memory _newBaseURI) public onlyOwner {
        baseURI = _newBaseURI;
    }

    function setBaseExtension(string memory _newBaseExtension)
        public
        onlyOwner
    {
        baseExtension = _newBaseExtension;
    }

    function pause() public onlyOwner {
        _pause();
    }

    function unpause() public onlyOwner {
        _unpause();
    }

    function updateWL(address addr, uint256 maxMint) public virtual onlyOwner {
        whiteListCount = whiteListCount - whiteLists[addr];
        whiteLists[addr] = maxMint;
        whiteListCount = whiteListCount + maxMint;
    }

    function pushMultiWL(address[] memory list, uint256 maxMint)
        public
        virtual
        onlyOwner
    {
        for (uint256 i = 0; i < list.length; i++) {
            whiteLists[list[i]] = maxMint;
            whiteListCount += maxMint;
        }
    }

    function pushMultiFreeMintLists(
        address[] memory addressList,
        uint256 maxMint
    ) public virtual onlyOwner {
        for (uint256 i = 0; i < addressList.length; i++) {
            freeMintLists[addressList[i]] = maxMint;
            freeMintListCount += maxMint;
        }
    }

    function deleteWL(address addr) public virtual onlyOwner {
        whiteListCount = whiteListCount - whiteLists[addr];
        delete (whiteLists[addr]);
    }

    function deleteFreemintList(address addr) public virtual onlyOwner {
        freeMintListCount = freeMintListCount - freeMintLists[addr];
        delete (freeMintLists[addr]);
    }

    function setWhiteListCount(uint256 _count) public onlyOwner {
        whiteListCount = _count;
    }

    function setFreeMintListCount(uint256 _count) public onlyOwner {
        freeMintListCount = _count;
    }

    function getWhiteListCount() public view returns (uint256) {
        return whiteListCount;
    }

    function getFreeMintListCount() public view returns (uint256) {
        return freeMintListCount;
    }

    function withdraw() external onlyOwner {
        Address.sendValue(payable(owner()), address(this).balance);
    }

    function whiteListCountOfOwner(address owner)
        public
        view
        returns (uint256)
    {
        return whiteLists[owner];
    }

    function freeMintListCountOfOwner(address owner)
        public
        view
        returns (uint256)
    {
        return freeMintLists[owner];
    }

    function _startTokenId() internal pure override returns (uint256) {
        return 1;
    }

    /**
     * @notice Change the royalty fee for the collection
     */
    function setRoyaltyFee(uint96 _feeNumerator) external onlyOwner {
        royaltyFee = _feeNumerator;
        _setDefaultRoyalty(royaltyAddress, royaltyFee);
    }

    /**
     * @notice Change the royalty address where royalty payouts are sent
     */
    function setRoyaltyAddress(address _royaltyAddress) external onlyOwner {
        royaltyAddress = _royaltyAddress;
        _setDefaultRoyalty(royaltyAddress, royaltyFee);
    }

    function supportsInterface(bytes4 interfaceId)
        public
        view
        virtual
        override(ERC721A, ERC2981)
        returns (bool)
    {
        // Supports the following `interfaceId`s:
        // - IERC165: 0x01ffc9a7
        // - IERC721: 0x80ac58cd
        // - IERC721Metadata: 0x5b5e139f
        // - IERC2981: 0x2a55205a
        return
            ERC721A.supportsInterface(interfaceId) ||
            ERC2981.supportsInterface(interfaceId);
    }
}

